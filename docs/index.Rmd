---
title: "Assessment"
author: "Bea"
date: "2024-11-01"
output:
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warnings=FALSE)
```

In this report, we examine the impact of a scabies outbreak on antiparasitic treatment trends and the preferred treatment options across Scotland during the second half of 2023 (June to December). The analysis focuses on prescription data to identify patterns and shifts in medication choices among health boards during this period.

# Loading Required Packages and Data

First, we will load the different **R packages** required for this report. These packages are necessary to clean, manipulate, visualize, and analyze the data. Next, we will load the **data for the months** we are interested in. In this case, we have used a URL to fetch the data, ensuring that the process can be replicated by anyone running the code.

```{r}
#Load packages
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(prettydoc)

#Load data
data_june23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/66e9611a-fbea-45b2-9edd-351c388fd06d/download/pitc202306.csv") %>% 
  clean_names()

data_july23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv") %>%
  clean_names()

data_aug23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/72ca4ad2-0228-4672-9eb0-cc911e4a8ca7/download/pitc202308.csv") %>% 
  clean_names()

data_sept23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2d3d240f-1467-4a91-9f0e-769745650cb9/download/pitc202309.csv") %>% 
  clean_names()

data_oct2023 <- read_csv( "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/94134438-db1d-4b8d-8f70-5e9b0e47bd03/download/pitc202310.csv") %>% 
  clean_names()

data_nov23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/21d11fed-a494-4e30-9bb6-46143c3b9530/download/pitc202311.csv") %>% 
  clean_names()

data_dec23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00cdf8d7-f784-4e87-894c-34f2540ea6ab/download/pitc202312.csv") %>% 
  clean_names()

```

## Loading Additional Data
Next, we will load additional data necessary for the analysis. In this case, we will load a list of the **Health Boards** and their corresponding names from which we will extract only the Health Board code and the Health Board name. Next, we will load the **population data**, which contains the population numbers for each Health Board. Since this is aggregated data, we will filter the dataset to select only the rows for "All". Finally, we will create a list of all the datasets for further processing.

```{r}
# Loading NHS Health Boards Data
NHS_healthboards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

# Extracting Health Board code and name
nhs_board <- NHS_healthboards %>% 
  select(hb, hb_name)

# Loading Population Data
population_data <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_14102024.csv") %>% 
  clean_names()

#A# Filter for aggregated data (for "All" sexes) in 2023
population_data2023 <- population_data %>% 
  filter(year == "2023" & sex == "All") %>% 
  select(hb, all_ages)

#Creating a list of datasets for each month in 2023
dataset_year23 <- list(June = data_june23, July = data_july23, August = data_aug23, September = data_sept23, October = data_oct2023, November = data_nov23, December = data_dec23)

```

# Data Analysis
We created a factor including the different treatments for scabies: **topical** (permethrin cream, malathion lotion, benzyl benzoate lotion, crotamiton cream and sulfur ointment), **oral** (ivermectin). 

## Trend Analysis over 2023
To visualize the trend of the scabies outbreak during the second half of 2023 (June to December), we combined all the monthly datasets into one using a list. This allowed us to create a comprehensive dataset that captured scabies treatment prescription trends over the specified months.

By joining the datasets, we ensured that the data was correctly aligned by month and treatment, and could be further analyzed to identify trends, patterns, and differences across health boards.

```{r}
#Factor with the treatments
scabies <- c("PERMETHRIN 5| PERMETHRIN_CR|MALATHI|BENZYL BENZOA| CROTAM|IVERMECTIN 3")

#Creating a full data set with all the months.
total_data23_sc <- dataset_year23 %>%
  imap_dfr(~ .x %>%
           filter(str_detect(bnf_item_description, scabies) & !is.na(bnf_item_description)) %>%
             group_by(hbt, gp_practice) %>%
             summarise(number_of_paid_items = sum(number_of_paid_items, na.rm = TRUE), .groups = "drop") %>%
             mutate(month = .y))

with_names_sc <- total_data23_sc %>% 
  full_join(nhs_board, join_by(hbt == hb)) %>% 
  mutate(month = factor(month, levels = c("June", "July", "August", "September", "October", "November", "December"), ordered = TRUE)) %>% 
  arrange(hb_name, month)

#Trend over the months 
no_gp <- with_names_sc %>% 
  filter(!is.na(month)) %>% 
  group_by(month, hb_name) %>% 
  summarise(number_of_paid_items = sum(number_of_paid_items))

sc_line <- no_gp %>% 
  ggplot(aes(x= month, y = number_of_paid_items))+
  geom_line(aes(group = hb_name, colour = hb_name), size = 1) +
  labs(title = "Scabies Outbreak in Scotland (June to December 2023)", subtitle = "Monthly Trends in Scabies Treatment Prescriptions", x = "Month", y = "Number of Antiparasitic Prescriptions", colour = "Health Board")+
  theme_bw()+
  guides(colour = guide_legend(title.position = "top", title.hjust = 0.5))+
  theme(legend.position = "bottom", legend.direction = "horizontal")+
  geom_text(data=. %>% 
              arrange(desc(month)) %>% 
              group_by(hb_name) %>% 
              slice(1), 
            aes(label=number_of_paid_items), 
            position=position_nudge(0.1), hjust=0, show.legend=FALSE)+
  scale_color_manual(values=c("#e6194b", "#ffe119", "#4363d8", "#f58231", 
              "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#3cb44b", "#fabebe",
              "#008080", "#e6beff", "#9a6324", "#fffac8"))

sc_line

```

## Analysis of Preferred Scabies Medications
In this section, we focus on identifying the preferred medications for scabies treatment across Scotland's health boards. To do so, we first isolated the relevant data, including the **health board, general practice, medication description**, and the **number of prescriptions** for each treatment. Next, we merged the dataset with the list of health boards to label each observation accordingly. This allowed us to associate each prescription with the
We will now analyse what are the preferred medication for scabies treatment with a bar plot.

```{r}

separated_data <- dataset_year23 %>%
  imap_dfr(~ .x %>%
            select(hbt, gp_practice, bnf_item_description, number_of_paid_items) %>% 
  filter(str_detect(bnf_item_description, scabies)) %>% 
             mutate(month = .y))

sep_with_names_sc <- separated_data %>% 
  full_join(nhs_board, join_by(hbt == hb)) %>% 
  filter(!is.na(number_of_paid_items))

sep_with_population_sc <- sep_with_names_sc %>% 
  full_join(population_data2023, join_by(hbt == hb)) 

sep_bar <- sep_with_names_sc %>% 
  ggplot(aes(x = hb_name, y = number_of_paid_items))+ scale_fill_brewer(palette = "Spectral")+
  geom_col(aes(fill = bnf_item_description), width = .5)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 65, hjust = 1))+
  labs(title = "Preferred Scabies Treatments Across Scotland", subtitle = "Breakdown by health board and treatment type (June - December 2023)", x = "Health Board", y = "Number of Prescriptions", fill = "Antiparasitic Medication")

sep_bar

```

This bar plot illustrates that the most commonly prescribed medication for scabies was permethrin cream. However, it is important to note that over time, resistance to permethrin has been observed in scabies populations, which may affect the efficacy of the treatment. Additionally, the preference for different scabies treatments can vary between countries, depending on factors such as medication availability and healthcare access.

## Relationship Between Different Treatments Over Time
To visualize the relationship between the different scabies treatments and their distribution across months, we have created a table showing the percentage of prescriptions for each medication per health board. We will focus on the health boards that experienced the highest impact, which could depend on the rate of scabies cases in those regions.

The table below presents the proportion of prescriptions for different scabies treatments (permethrin cream, malathion lotion, ivermectin tablets, and benzyl benzoate) from June to December 2023. It also shows how these proportions varied across different health boards in Scotland.

By calculating the percentage of each treatment prescribed relative to the total prescriptions in each health board and month, we can examine trends over time. This analysis highlights the most commonly used treatments for scabies and offers insights into regional variations in medication usage.

This table provides a clear view of the shifts in treatment preferences across health boards, enabling us to identify trends and the relative importance of different scabies treatments. The use of visual tools like this allows for a better understanding of the healthcare response to the scabies outbreak over the selected period.

```{r}

total_presc_table <- sep_with_names_sc %>%
  group_by(hb_name, month) %>%
  summarise(total_prescriptions = sum(number_of_paid_items)) %>%
  ungroup()


presc_table <- sep_with_names_sc %>% 
  filter(!is.na(bnf_item_description)) %>%
  group_by(hb_name, month, bnf_item_description) %>% 
  summarise(treatment_prescriptions = sum(number_of_paid_items, na.rm = TRUE)) %>% 
  full_join(total_presc_table, by = c("hb_name", "month")) %>% 
  mutate(percentage = (treatment_prescriptions / total_prescriptions) * 100)%>%
  group_by(hb_name) %>% 
  select(hb_name, month, bnf_item_description, percentage) %>% 
  mutate(month = factor(month, levels = c("June", "July", "August", "September", "October", "November", "December"))) %>%
  arrange(hb_name, month) %>%
  pivot_wider(names_from = bnf_item_description, values_from = percentage) %>%
  replace_na(list("MALATHION 0.5% AQUEOUS LIQUID" = 0, "PERMETHRIN 5% CREAM" = 0, "IVERMECTIN 3MG TABLETS" = 0, "BENZYL BENZOATE 25% APPLICATION" = 0)) %>% 
  gt()%>%
  tab_header(title = "Scabies Treatments by Health Board and Month", subtitle = "Data from Scottish Health Boards, June to December 2023") %>% 
  cols_label(hb_name = "Health Board", month = "Month", "MALATHION 0.5% AQUEOUS LIQUID" = "Malathion (%)", "PERMETHRIN 5% CREAM" = "Permethrin (%)", "IVERMECTIN 3MG TABLETS" = "Ivermectin (%)", "BENZYL BENZOATE 25% APPLICATION" = "Benzyl Benzoate (%)") %>% 
  fmt_number(columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION"), decimals = 1) %>% 
  cols_align(align = "center", columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION")) %>% 
  summary_rows(columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION"),fns = list("Average" = ~mean(., na.rm = TRUE)),fmt = list(~ fmt_number(., decimals = 2))) %>% 
  grand_summary_rows(columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION"),fns = list("Overall Average" = ~mean(., na.rm = TRUE)),fmt = list(~ fmt_number(., decimals = 1))) %>%  
  cols_move(columns = "IVERMECTIN 3MG TABLETS", after = "BENZYL BENZOATE 25% APPLICATION") %>%
  tab_spanner(label = "Topic Treatment", columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "BENZYL BENZOATE 25% APPLICATION")) %>% 
    tab_spanner(label = "Oral Treatment", columns = c("IVERMECTIN 3MG TABLETS")) 

presc_table

```

4TH FIGURE MAP
