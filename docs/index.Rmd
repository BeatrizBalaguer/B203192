---
title: "Assessment"
author: "Bea"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warnings=FALSE)
```

In this report, the effect of seasonal depression in Scotland will be assessed.

```{r}
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure (will be useful later)
library(glue)

data_june23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/66e9611a-fbea-45b2-9edd-351c388fd06d/download/pitc202306.csv") %>% 
  clean_names()

data_july23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv") %>%
  clean_names()

data_aug23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/72ca4ad2-0228-4672-9eb0-cc911e4a8ca7/download/pitc202308.csv") %>% 
  clean_names()

data_sept23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2d3d240f-1467-4a91-9f0e-769745650cb9/download/pitc202309.csv") %>% 
  clean_names()

data_oct2023 <- read_csv( "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/94134438-db1d-4b8d-8f70-5e9b0e47bd03/download/pitc202310.csv") %>% 
  clean_names()

```


```{r}

data_nov23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/21d11fed-a494-4e30-9bb6-46143c3b9530/download/pitc202311.csv") %>% 
  clean_names()

data_dec23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00cdf8d7-f784-4e87-894c-34f2540ea6ab/download/pitc202312.csv") %>% 
  clean_names()

population_data <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_14102024.csv") %>% 
  clean_names()

NHS_healthboards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

nhs_board <- NHS_healthboards %>% 
  select(hb, hb_name)

#it is aggregated data, we choose All
population_data2023 <- population_data %>% 
  filter(year == "2023" & sex == "All") %>% 
  select(hb, all_ages)


dataset_year23 <- list(June = data_june23,
                           July = data_july23,
                           August = data_aug23,
                           September = data_sept23,
                           October = data_oct2023,
                           November = data_nov23,
                           December = data_dec23)

```

We created a factor including the different treatments for scabies: topical (permethrin cream, malathion lotion, benzyl benzoate lotion, crotamiton cream and sulfur ointment), oral (ivermectin). Then the datasets were filtered for these medications, excluding any missing values...

To show the trend of the outbreak during the selected months, we joned all the datasets using a list... 

```{r}
scabies <- c("PERMETHRIN 5| PERMETHRIN_CR|MALATHI|BENZYL BENZOA| CROTAM|IVERMECTIN 3")

total_data23_sc <- dataset_year23 %>%
  imap_dfr(~ .x %>%
           filter(str_detect(bnf_item_description, scabies) & !is.na(bnf_item_description)) %>%
             group_by(hbt, gp_practice) %>%
             summarise(number_of_paid_items = sum(number_of_paid_items, na.rm = TRUE), .groups = "drop") %>%
             mutate(month = .y))

#with_gp <- total_data23_sc %>% 
  #full_join(gp_practice)



with_names_sc <- total_data23_sc %>% 
  full_join(nhs_board, join_by(hbt == hb)) %>% 
  mutate(month = factor(month, levels = c("June", "July", "August", 
                                          "September", "October", 
                                          "November", "December"), 
                        ordered = TRUE)) %>% 
  arrange(hb_name, month)


#Trend over the months 
no_gp <- with_names_sc %>% 
  filter(!is.na(month)) %>% 
  group_by(month, hb_name) %>% 
  summarise(number_of_paid_items = sum(number_of_paid_items))

sc_line <- no_gp %>% 
  ggplot(aes(x= month, y = number_of_paid_items))+
  geom_line(aes(group = hb_name, colour = hb_name), size = 1) +
  labs(title = "Scabies Outbreak in Scotland (June to December 2023)", subtitle = "Monthly Trends in Scabies Treatment Prescriptions", x = "Month", y = "Number of Antiparasitic Prescriptions", colour = "Health Board")+
  theme_bw()+
  guides(colour = guide_legend(title.position = "top", title.hjust = 0.5))+
  theme(legend.position = "bottom", legend.direction = "horizontal")+
  geom_text(data=. %>% 
              arrange(desc(month)) %>% 
              group_by(hb_name) %>% 
              slice(1), 
            aes(label=number_of_paid_items), 
            position=position_nudge(0.1), hjust=0, show.legend=FALSE)+
  scale_color_manual(values=c("#e6194b", "#ffe119", "#4363d8", "#f58231", 
              "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#3cb44b", "#fabebe",
              "#008080", "#e6beff", "#9a6324", "#fffac8"))

sc_line

```

We will now analyse what are the preferred medication for scabies treatment.

```{r}

separated_data <- dataset_year23 %>%
  imap_dfr(~ .x %>%
            select(hbt, gp_practice, bnf_item_description, number_of_paid_items) %>% 
  filter(str_detect(bnf_item_description, scabies)) %>% 
             mutate(month = .y))

sep_with_names_sc <- separated_data %>% 
  full_join(nhs_board, join_by(hbt == hb)) %>% 
  filter(!is.na(number_of_paid_items))

sep_with_population_sc <- sep_with_names_sc %>% 
  full_join(population_data2023, join_by(hbt == hb)) 

sep_bar <- sep_with_names_sc %>% 
  ggplot(aes(x = hb_name, y = number_of_paid_items))+ scale_fill_brewer(palette = "Spectral")+
  geom_col(aes(fill = bnf_item_description), width = .5)+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 65, hjust = 1))+
  labs(title = "Preferred Scabies Treatments Across Scotland", subtitle = "Breakdown by health board and treatment type (June - December 2023)", x = "Health Board", y = "Number of Prescriptions", fill = "Antiparasitic Medication")

sep_bar

```

In this histogram, it is represented how the most common medication for scabies was permethrin cream. Which has been seen to have an impact on the resistance of scabies to permethrin, causing some resistances of permethrin. Moreover, this relationship between different scabies treatments might vary between countries, as in Scotland the production of ivermectin is based in Ukraine, leading to shortages of this medication???????? (REFERENCE!).

To visualize the relationship between the different medications, a table using the percentages of the prescription of each medication per each health board has been made. We will focus on the top 5 more affected parts of Scotland??????(wouldnt this depend on rate??). 

```{r}

total_presc_table <- sep_with_names_sc %>%
  group_by(hb_name, month) %>%
  summarise(total_prescriptions = sum(number_of_paid_items)) %>%
  ungroup()


presc_table <- sep_with_names_sc %>% 
  filter(!is.na(bnf_item_description)) %>%
  group_by(hb_name, month, bnf_item_description) %>% 
  summarise(treatment_prescriptions = sum(number_of_paid_items, na.rm = TRUE)) %>% 
  full_join(total_presc_table, by = c("hb_name", "month")) %>% 
  mutate(percentage = (treatment_prescriptions / total_prescriptions) * 100)%>%
  group_by(hb_name) %>% 
  select(hb_name, month, bnf_item_description, percentage) %>% 
  mutate(month = factor(month, levels = c("June", "July", "August", "September", "October", "November", "December"))) %>%
  arrange(hb_name, month) %>%
  pivot_wider(names_from = bnf_item_description, values_from = percentage) %>%
  replace_na(list("MALATHION 0.5% AQUEOUS LIQUID" = 0, "PERMETHRIN 5% CREAM" = 0, "IVERMECTIN 3MG TABLETS" = 0, "BENZYL BENZOATE 25% APPLICATION" = 0)) %>% 
  gt()%>%
  tab_header(title = "Scabies Treatments by Health Board and Month", subtitle = "Data from Scottish Health Boards, June to December 2023") %>% 
  cols_label(hb_name = "Health Board", month = "Month", "MALATHION 0.5% AQUEOUS LIQUID" = "Malathion (%)", "PERMETHRIN 5% CREAM" = "Permethrin (%)", "IVERMECTIN 3MG TABLETS" = "Ivermectin (%)", "BENZYL BENZOATE 25% APPLICATION" = "Benzyl Benzoate (%)") %>% 
  fmt_number(columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION"), decimals = 1) %>% 
  cols_align(align = "center", columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION")) %>% 
  summary_rows(columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION"),fns = list("Average" = ~mean(., na.rm = TRUE)),fmt = list(~ fmt_number(., decimals = 2))) %>% 
  grand_summary_rows(columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "IVERMECTIN 3MG TABLETS","BENZYL BENZOATE 25% APPLICATION"),fns = list("Overall Average" = ~mean(., na.rm = TRUE)),fmt = list(~ fmt_number(., decimals = 1))) %>%  
  cols_move(columns = "IVERMECTIN 3MG TABLETS", after = "BENZYL BENZOATE 25% APPLICATION") %>%
  tab_spanner(label = "Topic Treatment", columns = c("MALATHION 0.5% AQUEOUS LIQUID", "PERMETHRIN 5% CREAM", "BENZYL BENZOATE 25% APPLICATION")) %>% 
    tab_spanner(label = "Oral Treatment", columns = c("IVERMECTIN 3MG TABLETS")) 

presc_table

```


