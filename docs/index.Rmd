---
title: "Assessment"
author: "Bea"
date: "2024-11-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, message=FALSE, warnings=FALSE)
```

In this report, the effect of seasonal depression in Scotland will be assessed.

```{r}
library(tidyverse)
library(janitor) # cleaning data
library(gt) # tables
library(here) # directory structure (will be useful later)
library(glue)

data_june23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/66e9611a-fbea-45b2-9edd-351c388fd06d/download/pitc202306.csv") %>% 
  clean_names()

data_july23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/7bb45ee6-6f1c-45f4-933b-958bdbe0ca4f/download/pitc202307.csv") %>%
  clean_names()

data_aug23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/72ca4ad2-0228-4672-9eb0-cc911e4a8ca7/download/pitc202308.csv") %>% 
  clean_names()

data_sept23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/2d3d240f-1467-4a91-9f0e-769745650cb9/download/pitc202309.csv") %>% 
  clean_names()

data_oct2023 <- read_csv( "https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/94134438-db1d-4b8d-8f70-5e9b0e47bd03/download/pitc202310.csv") %>% 
  clean_names()

```


```{r}

data_nov23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/21d11fed-a494-4e30-9bb6-46143c3b9530/download/pitc202311.csv") %>% 
  clean_names()

data_dec23 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/00cdf8d7-f784-4e87-894c-34f2540ea6ab/download/pitc202312.csv") %>% 
  clean_names()

population_data <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_14102024.csv") %>% 
  clean_names()

NHS_healthboards <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

nhs_board <- NHS_healthboards %>% 
  select(hb, hb_name)

#it is aggregated data, we choose All
population_data2023 <- population_data %>% 
  filter(year == "2023" & sex == "All") %>% 
  select(hb, all_ages)

```

SCABBIES??
We created a factor including the different treatments for scabbies: topical (permethrin cream, malathion lotion, benzyl benzoate lotion, crotamiton cream and sulfur ointment), oral (ivermectin).

```{r}
scabbies <- c("PERMETHRIN 5| PERMETHRIN_CR|MALATHI|BENZYL BENZOA| CROTAM|IVERMECTIN 3")


dataset_year23 <- list(June = data_june23,
                           July = data_july23,
                           August = data_aug23,
                           September = data_sept23,
                           October = data_oct2023,
                           November = data_nov23,
                           December = data_dec23)

separated_data <- dataset_year23 %>%
  imap_dfr(~ .x %>%
            select(hbt, gp_practice, bnf_item_description, number_of_paid_items) %>% 
  filter(str_detect(bnf_item_description, scabbies)) %>% 
             mutate(month = .y))

sep_with_names_sc <- separated_data %>% 
  full_join(nhs_board, join_by(hbt == hb))

sep_with_population_sc <- sep_with_names_sc %>% 
  full_join(population_data2023, join_by(hbt == hb))

sep_table <- sep_with_population_sc %>% 
  group_by(hb_name, bnf_item_description) %>% 
  select(hb_name, bnf_item_description, number_of_paid_items) %>%
  summarise(sum(number_of_paid_items)) %>% 
  gt()

sep_table

total_data23_sc <- dataset_year23 %>%
  imap_dfr(~ .x %>%
             filter(str_detect(bnf_item_description, scabbies) & !is.na(bnf_item_description)) %>%
             group_by(hbt, gp_practice) %>%
             summarise(number_of_paid_items = sum(number_of_paid_items, na.rm = TRUE), .groups = "drop") %>%
             mutate(month = .y))

#with_gp <- total_data23_sc %>% 
  #full_join(gp_practice)

with_names_sc <- total_data23_sc %>% 
  full_join(nhs_board, join_by(hbt == hb)) 

plotted_data23_sc <- with_names_sc %>% 
  ggplot(aes(x = month, y = number_of_paid_items))+
  geom_col()+
   theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  scale_x_discrete(limits = c("June", "July", "August","September","October", "November","December"))+
  facet_wrap(~hb_name)

plotted_data23_sc

```


